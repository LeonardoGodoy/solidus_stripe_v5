#!/usr/bin/env bash

set -e

extension_name="solidus_stripe"

# Stay away from the bundler env of the containing extension.
function unbundled {
  ruby -rbundler -e'Bundler.with_unbundled_env{system({"BUNDLE_SUPPRESS_INSTALL_USING_MESSAGES"=>"1"},*ARGV)}' -- "$@"
}

# "sqlite" is set by the ORB extension instead of "sqlite3",
# all other options are already in the format expected by `rails new`.
test "$DB" = "sqlite" && export DB="sqlite3"

rm -rf ./dummy-app
rails_version=`bundle exec ruby -e'require "rails"; puts Rails.version'`
rails _${rails_version}_ new dummy-app \
  --database=${DB:-sqlite3} \
  --skip-git \
  --skip-rc

if [ ! -d "dummy-app" ]; then
  echo 'dummy-app rails application failed'
  exit 1
fi

cd ./dummy-app

# Coverage
echo "require_relative '../../coverage.rb' if ENV['COVERAGE']" >> config/boot.rb
echo "gem 'simplecov', '~> 0.22', require: false" >> Gemfile
echo "gem 'rspec_junit_formatter', require: false" >> Gemfile
echo "gem 'codecov', require: false" >> Gemfile
unbundled bundle install

unbundled bundle add solidus --github solidusio/solidus --branch "${SOLIDUS_BRANCH:-master}" --version '> 0.a'
unbundled bundle exec rake db:drop db:create
unbundled bundle exec rails generate solidus:install --auto-accept --payment-method=none --no-seed --no-sample "$@"
unbundled bundle add $extension_name --path ..
unbundled bundle exec rails generate $extension_name:install --migrate --specs=all

